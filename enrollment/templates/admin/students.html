{% extends "admin/admin_sidebar.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Students</h3>
  <div>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStudentModal">Add Student</button>
  </div>
</div>

<div class="card p-3 mb-3">
  <div class="row g-2">
    <div class="col-md-4">
      <input id="searchInput" class="form-control" placeholder="Search by name or course">
    </div>

    <div class="col-md-3">
      <select id="courseFilter" class="form-select">
        <option value="">All courses</option>
        {% for c in all_courses %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <button id="clearFilters" class="btn btn-outline-secondary">Clear</button>
    </div>
  </div>
</div>

<div id="studentsTableWrapper" class="card p-3">
  <div class="table-responsive">
    <table id="studentsTable" class="table table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Course</th>
          <th>Enrolled</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for s in students %}
        <tr data-name="{{ s.name | lower }}" data-course="{{ s.course }}">
          <td>{{ s.id }}</td>
          <td>{{ s.name }}</td>
          <td>{{ s.course }}</td>
          <td>{{ s.date }}</td>

          <td>
            <button
              class="btn btn-sm btn-primary btn-edit"
              data-id="{{ s.id }}"
              data-name="{{ s.name }}"
              data-course="{{ s.course }}">
              Edit
            </button>

            <a href="/admin/students/delete/{{ s.id }}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Delete student?')">
               Delete
            </a>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center small">No students found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="/admin/students/add" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Student</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input name="name" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Course</label>
          <input name="course" class="form-control" required>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success">Add</button>
      </div>
    </form>
  </div>
</div>


<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editStudentForm" method="POST" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Student</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="id" id="edit_id">

        <div class="mb-3">
          <label class="form-label">Name</label>
          <input id="edit_name" name="name" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Course</label>
          <input id="edit_course" name="course" class="form-control" required>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>


<script>
  const searchInput = document.getElementById('searchInput');
  const courseFilter = document.getElementById('courseFilter');
  const rows = document.querySelectorAll('#studentsTable tbody tr');

  function applyFilters() {
    const q = searchInput.value.toLowerCase();
    const course = courseFilter.value.toLowerCase();

    rows.forEach(r => {
      const name = r.dataset.name || '';
      const c = r.dataset.course || '';
      const show = (name.includes(q) || c.includes(q)) && (course === '' || c === course);
      r.style.display = show ? '' : 'none';
    });
  }

  searchInput.addEventListener('input', applyFilters);
  courseFilter.addEventListener('change', applyFilters);

  document.getElementById('clearFilters').addEventListener('click', () => {
    searchInput.value = '';
    courseFilter.value = '';
    applyFilters();
  });

  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('edit_id').value = btn.dataset.id;
      document.getElementById('edit_name').value = btn.dataset.name;
      document.getElementById('edit_course').value = btn.dataset.course;

      document.getElementById('editStudentForm').action =
        `/admin/students/edit/${btn.dataset.id}`;

      new bootstrap.Modal(document.getElementById('editStudentModal')).show();
    });
  });
</script>

{% endblock %}
